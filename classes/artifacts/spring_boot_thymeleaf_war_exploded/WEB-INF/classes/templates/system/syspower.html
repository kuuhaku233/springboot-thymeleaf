<!DOCTYPE html>
<html xmlns:shiro="http://www.pollix.at/thymeleaf/shiro"
      xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="IE=edge" http-equiv="X-UA-Compatible">

<title>用户管理页面</title>

<style>
    .bootstrap-table .fixed-table-container .table tbody tr.selected td {
        background-color: inherit;
        color: inherit;
    }

    .roletog {
        background-color: #294f75 !important;
        color: #ffffff !important;
        color: inherit;
    }
</style>

<!--Bootstrap Stylesheet [ REQUIRED ]-->
<link rel="stylesheet" th:href="@{/static/css/bootstrap.min.css}">

<!--Nifty Stylesheet [ REQUIRED ]-->
<link rel="stylesheet" th:href="@{/static/css/nifty.min.css}">

<!--Nifty Premium Icon [ DEMONSTRATION ]-->
<link rel="stylesheet" th:href="@{/static/css/demo/nifty-demo-icons.min.css}">


<!--=================================================-->
<!--Pace - Page Load Progress Par [OPTIONAL]-->
<link rel="stylesheet" th:href="@{/static/plugins/pace/pace.min.css}">
<script th:src="@{/static/plugins/pace/pace.min.js}"></script>


<!--Demo [ DEMONSTRATION ]-->
<link rel="stylesheet" th:href="@{/static/css/demo/myfonts/iconfont.css}">

<!--DataTables [ OPTIONAL ]-->
<link rel="stylesheet" th:href="@{/static/plugins/datatables/media/css/dataTables.bootstrap.css}">
<link rel="stylesheet"
      th:href="@{/static/plugins/datatables/extensions/Responsive/css/responsive.dataTables.min.css}">

<!--  表单验证的css -->
<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-validator/bootstrapValidator.min.css}">

<!--JSTree [ OPTIONAL ]-->
<link rel="stylesheet" th:href="@{/static/plugins/jstree/themes/default/style.min.css}">
<link rel="stylesheet" th:href="@{/static/plugins/font-awesome/css/font-awesome.min.css}">

<!-- bootstrapTable的css-->
<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-table/bootstrap-table.css}">
<!-- 引入bootstrapTable的treegrid css -->
<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-table/extensions/treegrid/jquery.treegrid.css}">
<!-- 引入bootstrap select的css -->
<link rel="stylesheet" th:href="@{/static/plugins/bootstrap-select/bootstrap-select.css}">
<script th:src="@{/static/js/jquery.min.js}"></script>
</head>

<body>
<div class="effect aside-float aside-bright mainnav-lg" id="container">

    <!--头部导航-->
    <th:block th:include="/common/header.html"></th:block>
    <!--头部导航结束-->

    <div class="boxed">

        <!--CONTENT CONTAINER-->
        <!--===================================================-->
        <div id="content-container">
            <div id="page-head">

                <!--Page Title-->
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <div id="page-title">
                    <h1 class="page-header text-overflow">用户管理</h1>
                </div>
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <!--End page title-->


                <!--Breadcrumb-->
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <ol class="breadcrumb">
                    <li><a href="#"><i class="demo-pli-home"></i></a></li>
                    <li><a href="#">系统管理</a></li>
                    <li class="active">权限管理</li>
                </ol>
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <!--End breadcrumb-->

            </div>


            <!--Page content-->
            <!--===================================================-->
            <div id="page-content">

                <!-- Basic Data Tables -->
                <!--===================================================-->
                <div class="panel">
                    <div class="panel-body">
                        <div class="fixed-fluid">
                            <!-- 页面左侧部分 角色列表 -->
                            <div class="fixed-sm-200 pull-sm-left fixed-right-border">

                                <div class="pad-btm bord-btm">
                                    <a class="btn btn-block btn-primary">角色列表</a>
                                </div>
                                <div class="list-group bg-trans pad-btm bord-btm" id="rolelist">

                                </div>


                            </div>
                            <div class="fluid">
                                <!-- 页面左侧部分 角色列表 结束-->

                                <!-- 页面右侧部分 资源列表 -->
                                <div id="demo-email-list">
                                    <div class="row">
                                        <div class="pad-btm bord-btm">
                                            <a class="btn btn-block btn-primary">资源列表</a>
                                        </div>
                                    </div>
                                    <ul class="mail-list pad-top bord-top" id="demo-mail-list">
                                        <div class="mar-btm" id="btntest1">
                                                <button shiro:hasPermission="../link/save_btn" class="btn btn-primary" id="savepower">保存</button>
                                        </div>
                                        <table cellspacing="0" class="table table-striped table-bordered"
                                               id="resource-table"
                                               width="100%">
                                            <thead>
                                            <tr>
                                                <th></th>
                                                <th>reid</th>
                                                <th>资源名称</th>
                                                <th>资源链接</th>
                                                <th>资源图标</th>
                                                <th>状态</th>
                                            </tr>
                                            </thead>

                                        </table>
                                    </ul>
                                </div>
                                <!-- 页面右侧部分 资源列表 结束-->
                            </div>
                        </div>
                    </div>
                    <!--===================================================-->
                    <!-- End Striped Table -->


                </div>
                <!--===================================================-->
                <!--End page content-->

            </div>
            <!--===================================================-->
            <!--END CONTENT CONTAINER-->


            <!--右侧导航-->
            <th:block th:include="/common/aside.html"></th:block>
            <!--右侧导航结束-->


            <!--左侧导航-->
            <th:block th:include="/common/nav.html"></th:block>
            <!--左侧导航结束-->

        </div>


        <!-- FOOTER -->
        <!--===================================================-->
        <footer id="footer">

            <!-- Visible when footer positions are fixed -->
            <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
            <div class="show-fixed pad-rgt pull-right">
                You have <a class="text-main" href="#"><span class="badge badge-danger">3</span> pending action.</a>
            </div>


            <!-- Visible when footer positions are static -->
            <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
            <div class="hide-fixed pull-right pad-rgt">
                14GB of <strong>512GB</strong> Free.
            </div>


            <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
            <!-- Remove the class "show-fixed" and "hide-fixed" to make the content always appears. -->
            <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

            <p class="pad-lft">&#0169; 2017 Your Company</p>


        </footer>
        <!--===================================================-->
        <!-- END FOOTER -->


        <!-- SCROLL PAGE BUTTON -->
        <!--===================================================-->
        <button class="scroll-top btn">
            <i class="pci-chevron chevron-up"></i>
        </button>
        <!--===================================================-->


    </div>


    <!--jQuery -->
    <script th:src="@{/static/js/jquery.min.js}"></script>

    <!--BootstrapJS -->
    <script th:src="@{/static/js/bootstrap.min.js}"></script>

    <!--NiftyJS -->
    <script th:src="@{/static/js/nifty.min.js}"></script>

    <!--Demo script -->
    <script th:src="@{/static/js/demo/nifty-demo.min.js}"></script>
    <script th:src="@{/static/plugins/datatables/media/js/jquery.dataTables.js}"></script>
    <script th:src="@{/static/plugins/datatables/media/js/dataTables.bootstrap.js}"></script>
    <script th:src="@{/static/plugins/datatables/extensions/Responsive/js/dataTables.responsive.min.js}"></script>

    <!--  datatable bootbox 表格插件 -->
    <script th:src="@{/static/js/demo/tables-datatables.js}"></script>
    <script th:src="@{/static/plugins/bootbox/bootbox.min.js}"></script>


    <!-- 引入bootstrapTable 的js插件 -->
    <script th:src="@{/static/plugins/bootstrap-table/extensions/treegrid/jquery.treegrid.min.js}"></script>
    <script th:src="@{/static/plugins/bootstrap-table/bootstrap-table.min.js}"></script>
    <!-- 引入bootstrapTable的语言包 -->
    <script th:src="@{/static/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.js}"></script>
    <!-- 引入treegrid插件 -->
    <script th:src="@{/static/plugins/bootstrap-table/extensions/treegrid/bootstrap-table-treegrid.js}"></script>
    <!-- 引入bootstrap select的插件-->
    <script th:src="@{/static/plugins/bootstrap-select/bootstrap-select.js}"></script>
    <!-- Live2D 看板动画-->
    <!--<script th:src="@{./lib/L2Dwidget.min.js}"></script>
    <script type="text/javascript">
        L2Dwidget.init({
            "model": {
                jsonPath:
                    "https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json",
                "scale": 0.8
            }, "display": {
                "position": "left", "width": 200, "height": 270,
                "hOffset": 40, "vOffset": 20,

            }, "mobile": {"show": true, "scale": 0.5},
            "react": {opacity: 0.8},
            dialog: {
                // 开启对话框
                enable: true,
                script: {
                    // 每空闲 10 秒钟，显示一条一言
                    'every idle 8s': '$hitokoto$',
                    // 当触摸到星星图案
                    'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
                    // 当触摸到角色身体
                    'tap body': '哎呀！别碰我！',
                    // 当触摸到角色头部
                    'tap face': '人家已经不是小孩子了！'
                }
            }
        });

    </script>-->

    <!--<%表单验证js%>-->
    <!--<script>
        $(function () {
            $("#formadd,#formupdate").bootstrapValidator({
                message: 'This value is not valid',
                //验证显示的图标
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                //验证规则
                fields: {
                    username: {
                        validators: {
                            notEmpty: {
                                message: '用户名不能为空'
                            },
                            stringLength: {
                                min: 6,
                                max: 18,
                                message: '用户名长度必须在6到18位之间'
                            },
                        }
                    },
                    password: {
                        validators: {
                            notEmpty: {
                                message: '密码不能为空'
                            },
                            stringLength: {
                                min: 6,
                                max: 18,
                                message: '密码长度必须在6到18位之间'
                            },
                        }
                    },
                    email: {
                        validators: {
                            notEmpty: {
                                message: '邮箱不能为空'
                            },
                            emailAddress: {
                                message: '邮箱地址格式有误'
                            }
                        }
                    },

                    phone: {
                        validators: {
                            notEmpty: {
                                message: '手机号不能为空'
                            },
                            regexp: {
                                regexp: /^1[34578]\d{9}$/,
                                message: '手机号格式不正确'
                            },
                            remote: {//ajax验证。server result:{"valid",true or false}
                                url: "../system/userphoneyanzheng",
                                message: '改手机号已经注册过',
                                delay: 1000,//ajax刷新的时间是1秒一次
                                type: 'POST',

                                //自定义提交数据，默认值提交当前input value
                                data: ""
                            }

                        }
                    },
                    register_address: {
                        validators: {
                            notEmpty: {
                                message: '注册地址不能为空'
                            }
                        }
                    },
                    register_time: {
                        validators: {
                            notEmpty: {
                                message: '注册时间不能为空'
                            }
                        }
                    },

                }

            })

        })
    </script>-->

    <!--<% datatable数据的获取 %>-->
    <!-- bootstrapTable 数据获取 -->
    <script>
        var $table = $('#resource-table')
        var rid = '';
        //构建bootstrapTable
        $(function () {

            function ftb(rid) {
                var reids = [];
                $table.bootstrapTable('destroy').bootstrapTable({
                    destroy: true,
                    //toolbar: "#btntest1",
                    idField: "reid",//设置列为选中列
                    url: "../system/getpwoerresource",
                    locale: 'zh-CN',
                    queryParams: "rid=" + rid, //bootstrapTable ajax传递参数
                    // pagination: true,//分页
                    /* pageNumber: 1,//默认显示第1也
                     pageSize: 10,//每页显示的数量
                     pageList: [5, 10, 20, 50, 100],//设置每页显示的数量*/
                    // search: true,//搜索
                    //sidePagination: 'server',//设置服务器端分页*********************
                    //showRefresh: true, //显示刷新按钮
                    //showColumns: true,//显示列刷选
                    silent: true,

                    striped: true,
                    columns: [
                        {
                            checkbox: true,

                        },
                        {
                            field: "reid",
                            visible: false,
                        },
                        {
                            field: "resourcename",
                        },
                        {
                            field: "relink",
                        },
                        {
                            field: "rebianhao",
                            formatter: function (val) {
                                return '<span class="' + val + '"></span>'
                            },
                            sortable: true,

                        },
                        {
                            field: "powerreid",
                            formatter: function (val) {
                                if (val != null) {
                                    reids.push(val);
                                    return '<span class="label label-info">拥有权限</span>'
                                } else {
                                    return '<span class="label label-danger">未拥有权限</span>'
                                }
                            },

                        },

                    ],
                    treeShowField: 'resourcename',
                    parentIdField: 'reopjigouid',

                    onResetView: function (data) {

                        $table.treegrid({
                            initialState: 'expanded',// 所有节点都折叠
                            // initialState: '',// 所有节点都展开，默认展开
                            treeColumn: 1,
                            expanderExpandedClass: 'glyphicon glyphicon-triangle-bottom',  //图标样式
                            expanderCollapsedClass: 'glyphicon glyphicon-triangle-right',
                            onChange: function () {
                                $table.bootstrapTable('resetWidth');
                            }
                        });

                        //只展开树形的第一级节点
                        $table.treegrid('getRootNodes').treegrid('expand');

                    },
                    onLoadSuccess: function () {
                        $table.bootstrapTable('checkBy', {field: 'reid', values: reids});
                    }
                });
            }


            //查询出 所有的角色信息
            $(function () {
                $.ajax({
                    url: '../system/findAll',
                    success: function (data) {
                        if (data != null) {
                            if (data == 'loseSession') {
                                window.location.href = "login.jsp"
                            }
                            for (var i = 0; i < data.length; i++)
                                $("#rolelist").append(
                                    ' <a href="javascript:void(0)" class="list-group-item" id="' + data[i].rid + '">' + data[i].rname + ' </a>'
                                )
                        }
                    }
                });

                //点击角色名称查出角色对应的权限信息
                $("#rolelist").on('click', 'a', function () {
                    $(this).addClass("roletog");
                    $(this).siblings().removeClass("roletog");
                    rid = $(this).attr("id");
                    ftb(rid);
                })
                //

                //权限修改
                $("#savepower").on('click', function () {
                    $.ajax({
                        url: "../system/deleteResourceByRid",
                        data: "rid=" + rid,
                        success: function (data) {
                            if (data < -1) {
                                return;
                            } else {
                                var selects = $table.bootstrapTable('getSelections');
                                var reids = [];

                                for (var i = 0; i < selects.length; i++) {
                                    reids.push(selects[i].reid);
                                }
                                console.log("rid:" + rid)
                                console.log("reids:" + reids)
                                $.ajax({
                                    url: '../system/updaterolepower',
                                    data: {
                                        reids: reids.toString(),
                                        rid: rid
                                    },
                                    success: function (data) {
                                        if (data > -1) {
                                            $.niftyNoty({
                                                type: 'info',
                                                icon: 'pli-exclamation icon-2x',
                                                message: '修改权限成功',
                                                container: 'floating',
                                                timer: 3000
                                            });

                                        }
                                        ftb(rid);
                                    }
                                })
                            }
                        }
                    });


                })


            });


        })


    </script>
</div>
</body>
</html>


<!DOCTYPE html>
<html xmlns:shiro="http://www.pollix.at/thymeleaf/shiro"
      xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">

    <title>发送快件页面</title>

    <!--Bootstrap Stylesheet [ REQUIRED ]-->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">

    <!--Nifty Stylesheet [ REQUIRED ]-->
    <link rel="stylesheet" th:href="@{/css/nifty.min.css}">

    <!--Nifty Premium Icon [ DEMONSTRATION ]-->
    <link rel="stylesheet" th:href="@{/css/demo/nifty-demo-icons.min.css}">
    <link rel="stylesheet" th:href="@{/css/demo/myfonts/iconfont.css}">
    <!--Pace - Page Load Progress Par [OPTIONAL]-->
    <link rel="stylesheet" th:href="@{/plugins/pace/pace.min.css}">
    <script th:src="@{/plugins/pace/pace.min.js}"></script>


    <!--DataTables [ OPTIONAL ]-->
    <link rel="stylesheet" th:href="@{/plugins/datatables/media/css/dataTables.bootstrap.css}">
    <link rel="stylesheet"
          th:href="@{/plugins/datatables/extensions/Responsive/css/responsive.dataTables.min.css}">

    <!--Bootstrap Validator 表单验证-->
    <link rel="stylesheet" th:href="@{/plugins/bootstrap-validator/bootstrapValidator.min.css}">

    <!-- 引入bootstrap select的css -->
    <link rel="stylesheet" th:href="@{/plugins/bootstrap-select/bootstrap-select.css}">

    <script th:src="@{/js/jquery.min.js}"></script>


</head>

<body>
<div class="effect aside-float aside-bright mainnav-lg" id="container">

    <!--头部导航-->
    <th:block th:include="/common/header.html"></th:block>
    <!--头部导航结束-->


    <div class="boxed">

        <!--CONTENT CONTAINER-->
        <!--===================================================-->
        <div id="content-container">
            <div id="page-head">

                <!--Page Title-->
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <div id="page-title">
                    <h1 class="page-header text-overflow">签收快件</h1>
                </div>
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <!--End page title-->


                <!--Breadcrumb-->
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <ol class="breadcrumb">
                    <li><a href="#"><i class="demo-pli-home"></i></a></li>
                    <li>用户操作</a></li>
                    <li class="active">发送快件</li>
                </ol>
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <!--End breadcrumb-->

            </div>


            <!--Page content-->
            <!--===================================================-->
            <div id="page-content">

                <!-- Basic Data Tables -->
                <!--===================================================-->
                <div class="panel">

                    <div class="panel-body">
                        <div class="mar-btm">
                            <button class="btn btn-primary" data-target="#useradd" data-toggle="modal"
                                    shiro:hasPermission="../link/add_btn">新增
                            </button>
                        </div>
                        <table cellspacing="0" class="table table-striped table-bordered" id="demo-dt-basic"
                               width="100%">
                            <th><input type="checkbox" name="allusers" id="checkAll"></th>
                        </table>
                    </div>
                </div>
                <!--===================================================-->
                <!-- End Striped Table -->


            </div>
            <!--===================================================-->
            <!--End page content-->

        </div>
        <!--===================================================-->
        <!--END CONTENT CONTAINER-->


        <!--右侧导航-->
        <th:block th:include="/common/aside.html"></th:block>
        <!--右侧导航结束-->


        <!--左侧导航-->
        <th:block th:include="/common/nav.html"></th:block>
        <!--左侧导航结束-->

    </div>

    <!-- FOOTER -->
    <th:block th:include="/common/footer.html"></th:block>
    <!-- END FOOTER -->


    <!-- SCROLL PAGE BUTTON -->
    <!--===================================================-->
    <button class="scroll-top btn">
        <i class="pci-chevron chevron-up"></i>
    </button>
    <!--===================================================-->


</div>
<!--修改弹出框-->
<div class="modal" id="rolexiugai" role="dialog" tabindex="-1" style="height: 800px;">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: 1px solid #ddd">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">修改发货信息</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="formupdate">
                    <input name="id" type="hidden">
                    <div class="panel-body">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">收件人：</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="username" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">收件人电话：</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="phone" type="text" >
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">收件人地址：</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="station" type="text" >
                            </div>
                        </div>
                        <div class="form-group">
                            <script id="descs" name="descs"></script>
                        </div>
                    </div>
                    <div class="panel-footer text-right">
                        <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
                        <button class="btn btn-success" id="xgbtn" type="button">签收</button>
                    </div>
                </form>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!--新增弹出框-->
<div class="modal" id="useradd" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: 1px solid #ddd">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">新增发件信息</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="formadd">
                    <input name="id" type="hidden">
                    <div class="panel-body">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">收货人：</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="username"  type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">收货地址：</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="station" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">收货人手机号：</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="phone" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <script id="adddescs" name="descs"></script>
                        </div>
                    </div>
                    <!--                    <div class="panel-footer text-right">-->
                    <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
                    <button class="btn btn-success" id="addbaocun" type="button">新增</button>
                    <!--                    </div>-->
                </form>
            </div>

        </div><!-- /.modal-content -->
    </div>
</div><!-- /.modal -->


<!--jQuery [ REQUIRED ]-->

<!--BootstrapJS [ RECOMMENDED ]-->
<script th:src="@{/js/bootstrap.min.js}"></script>
<!--NiftyJS [ RECOMMENDED ]-->
<script th:src="@{/js/nifty.min.js}"></script>
<!--Demo script [ DEMONSTRATION ]-->
<!--<script th:src="@{/js/demo/nifty-demo.min.js}"></script>-->


<!--DataTables [ OPTIONAL ]-->
<script th:src="@{/plugins/datatables/media/js/jquery.dataTables.js}"></script>
<script th:src="@{/plugins/datatables/media/js/dataTables.bootstrap.js}"></script>
<script th:src="@{/plugins/datatables/extensions/Responsive/js/dataTables.responsive.min.js}"></script>

<script th:src="@{/plugins/bootbox/bootbox.min.js}"></script>

<!--Bootstrap Validator 表单验证-->
<script th:src="@{/plugins/bootstrap-validator/bootstrapValidator.min.js}"></script>
<!-- 引入富文本编辑器 -->
<script th:src="@{/ueditor/ueditor.config.js}"></script>
<script th:src="@{/ueditor/ueditor.all.js}"></script>


<!--
<script th:src="@{/lib/L2Dwidget.min.js}"></script>
<script type="text/javascript">
    L2Dwidget.init({
        "model": {
            jsonPath:
                "https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json",
            "scale": 0.8
        }, "display": {
            "position": "left", "width": 200, "height": 270,
            "hOffset": 40, "vOffset": 20,

        }, "mobile": {"show": true, "scale": 0.5},
        "react": {opacity: 0.7},
        dialog: {
            // 开启对话框
            enable: true,
            script: {
                // 每空闲 10 秒钟，显示一条一言
                'every idle 8s': '$hitokoto$',
                // 当触摸到星星图案
                'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
                // 当触摸到角色身体
                'tap body': '哎呀！别碰我！',
                // 当触摸到角色头部
                'tap face': '人家已经不是小孩子了！'
            }
        }
    });

</script >
-->
<th:block th:include="common/live2d"></th:block>

<!--表单验证js-->
<script>
    $(function () {
        $("#formadd,#formupdate").bootstrapValidator({
            message: 'This value is not valid',
            //验证显示的图标
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            //验证规则
            fields: {
                station: {
                    validators: {
                        notEmpty: {
                            message: '收货地址不能为空'
                        },
                    }
                },
                phone: {
                    validators: {
                        notEmpty: {
                            message: '手机号不能为空'
                        },
                        regexp: {
                            regexp: /^1[34578]\d{9}$/,
                            message: '手机号格式不正确'
                        },
                    }
                },
                username: {
                    validators: {
                        notEmpty: {
                            message: '收货人不能为空'
                        },
                    }
                },
                /*phone: {
                    validators: {
                        notEmpty: {
                            message: '手机号不能为空'
                        },
                        regexp: {
                            regexp: /^1[34578]\d{9}$/,
                            message: '手机号格式不正确'
                        },
                        remote: {//ajax验证。server result:{"valid",true or false}
                            url: "../system/userphoneyanzheng",
                            message: '改手机号已经注册过',
                            delay: 1000,//ajax刷新的时间是1秒一次
                            type: 'POST',

                            //自定义提交数据，默认值提交当前input value
                            data: ""
                        }

                    }
                },*/
                register_address: {
                    validators: {
                        notEmpty: {
                            message: '注册地址不能为空'
                        }
                    }
                },
                register_time: {
                    validators: {
                        notEmpty: {
                            message: '注册时间不能为空'
                        }
                    }
                },

            }

        })

    })
</script>

<script>
    /*UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
           UE.Editor.prototype.getActionUrl = function(action) {
               if (action == 'uploadimage' || action == 'uploadfile' ) {
                   return '/ueditor/upload.do';
               } else {
                   return this._bkGetActionUrl.call(this, action);
               }
           };*/
    //构建datatable
    var ue = UE.getEditor('descs',{
        autoHeightEnabled: false,
        initialFrameHeight:350,
        zIndex:1039
    });
    var dt = $("#demo-dt-basic").DataTable({
        //会有参数，用来开启datatable的相关功能
        "ordering": true,
        "processing": true,
        //"serverSide": true,//开启服务器端处理
        searching: true,
        ajax: {
            "url": "/selectfhxx",
            dataSrc: "",
        },
        columns: [
            {
                data: 'id',
                orderable: false,//制定是否排序
                //数据渲染
                render: function (data, type, row, meta) {
                    return '<input type="checkbox" name="checkusers" id=' + data + ' value=' + data + '>'
                }
            },
            {
                data: 'danhao',
                title: "快递单号",
                orderable: false,//制定是否排序
            },
            {
                data: 'tousername',
                title: "发件人",
                orderable: false,//制定是否排序
            },
            {
                data: 'username',
                title: "收件人",
                orderable: false,//制定是否排序
            },
            {
                data: 'phone',
                title: "收件人电话",
                orderable: false,//制定是否排序
            },
            {
                data: 'fromphone',
                title: "发件人电话",
                orderable: false,//制定是否排序
            },

            {
                data: 'station',
                title: "目的地",
                orderable: false,//制定是否排序
            },
            {
                title: "发出地",
                data: 'curstation',
                orderable: false,
            },
            {
                data: 'time',
                title: "邮寄时间",
                orderable: false,//制定是否排序
            },
            {
                data: 'state',
                title: "状态",
                orderable: false,//制定是否排序
                render: function (data, type, row, meta) {
                    if (data == 1) {
                        return "<div class='label label-table label-danger'>待发货</div>"
                    }else {
                        return "<div class='label label-table label-success'>已发货</div>"
                    }

                }
            },
            {
                title: "详细信息",
                data: 'descs',
                visible:false
            },
            {
                title: "操作",
                data: null,
                orderable: false,
                defaultContent: '<a title="修改"  href="javascript::##" shiro:hasPermission= "../link/update_btn" class="xiugai" ><i class="myfont icon-tianxie"></i></a>' +
                    '<a title="删除" href="javascript::##" shiro:hasPermission= "../link/delete_btn" class="shanchu" ><i class="myfont icon-shanchu"></i></a>' +
                    '<a title="确定发货" href="javascript::##" shiro:hasPermission= "../link/delete_btn" class="chakan" ><i class="myfont icon-xiayibu"></i></a>'
            }
        ],
        language: {
            "sProcessing": "处理中...",
            "sLengthMenu": "显示 _MENU_ 项结果",
            "sZeroRecords": "没有匹配结果",
            "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
            "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
            "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
            "sInfoPostFix": "",
            "sSearch": "搜索:",
            "sUrl": "",
            "sEmptyTable": "表中数据为空",
            "sLoadingRecords": "载入中...",
            "sInfoThousands": ",",
            "oPaginate": {
                "sFirst": "首页",
                "sPrevious": "上页",
                "sNext": "下页",
                "sLast": "末页"
            },
            "oAria": {
                "sSortAscending": ": 以升序排列此列",
                "sSortdescsending": ": 以降序排列此列"
            }
        },

    });

    //修改角色信息
    $("#demo-dt-basic").on("click", ".xiugai", function () {

        $("#rolexiugai").modal("show");

        //datatable取值，先获取行号
        var thisindex = $(this).parent().parent().index();
        //构建datatable的变量
        var t = $("#demo-dt-basic").DataTable();
        var id = t.row(thisindex).data().id;
        var station = t.row(thisindex).data().station;
        var phone = t.row(thisindex).data().phone;
        var username = t.row(thisindex).data().username;

        //把当前的数据付给弹出框
        $("#rolexiugai input[name=id]").val(id)
        $("#rolexiugai input[name=station]").val(station)
        $("#rolexiugai input[name=phone]").val(phone)
        $("#rolexiugai input[name=username]").val(username)
       /* $("#rolexiugai input[name=time]").val(getMyDate(time))
        $("#rolexiugai input[name=username]").val(username)*/
         // $("#rolexiugai textarea[name=descs]").val(descs)

        //关键代码！
        $(function () {
            var descs = t.row(thisindex).data().descs;
            //赋值
            ue.setContent(" ");
            ue.setContent(descs);
        })



        $("#xgbtn").off("click").on("click", function () {
            var vali = $("#formupdate").data('bootstrapValidator').validate().isValid();
            if(vali)
            {
                $.ajax({
                    url: "../updateYj",
                    data: {"id":id,
                           "qhm":$("#shm").val(),},
                    success: function (data) {
                        if (data == true) {
                            $("#rolexiugai").modal("hide");
                            $.niftyNoty({
                                type: 'info',
                                icon: 'pli-exclamation icon-2x',
                                message: '修改数据成功',
                                container: 'floating',
                                timer: 3000
                            });
                            dt.ajax.reload();
                        }else {
                            bootbox.alert("取货码错误请重试");
                        }
                    }
                })
            }



        })

    })

    //删除出库信息
    $("#demo-dt-basic").on("click", ".shanchu", function () {
        var $_this = $(this).parent().parent();
        //datatable取值，先获取行号
        var thisindex = $(this).parent().parent().index();
        //构建datatable的变量
        var t = $("#demo-dt-basic").DataTable();
        var id = t.row(thisindex).data().id;
        var ruser = t.row(thisindex).data().ruser;
        bootbox.confirm({
            size: "small",
            message: "确认要删除该条数据吗？",
            buttons: {
                confirm: {
                    label: '删除',
                    className: 'btn-danger'
                },
                cancel: {
                    label: '取消',

                }
            },
            callback: function (result) {
                if (result) {
                    $.ajax({
                        url: '../deleteYj',
                        data: "id=" + id,
                        success: function (data) {
                            if (data) {
                                $_this.hide(1000);
                                dt.ajax.reload();
                                $.niftyNoty({
                                    type: 'info',
                                    icon: 'pli-exclamation icon-2x',
                                    message: '删除数据成功',
                                    container: 'floating',
                                    timer: 3000
                                });
                            }
                        }
                    })
                }
            }
        })
    })
    //出库
    // $("#demo-dt-basic").on("click", ".chakan", function () {
    //     var thisindex = $(this).parent().parent().index();
    //     var id = dt.row(thisindex).data().id;
    //     bootbox.confirm({
    //         size: "small",
    //         message: "确要出库吗？",
    //         buttons: {
    //             confirm: {
    //                 label: '确定',
    //                 className: 'btn-danger'
    //             },
    //             cancel: {
    //                 label: '取消',
    //
    //             }
    //         },
    //         callback: function (result) {
    //             if (result) {
    //                 $.ajax({
    //                     url: '../updateck',
    //                     data: "id=" + id,
    //                     success: function (data) {
    //                         if (data) {
    //                             dt.ajax.reload();
    //                             $.niftyNoty({
    //                                 type: 'info',
    //                                 icon: 'pli-exclamation icon-2x',
    //                                 message: '出库成功',
    //                                 container: 'floating',
    //                                 timer: 3000
    //                             });
    //                         }
    //                     }
    //                 })
    //             }
    //         }
    //     })
    // })


    var ueadd = UE.getEditor('adddescs',{autoHeightEnabled: false,
        initialFrameHeight:350,
        zIndex:1039});
    //新增角色
    $("#addbaocun").on("click", function () {


        ueadd.addListener("ready", function () {
            // ueadd.setContent("请添加描述信息:");
        })

        var vali = $("#formadd").data('bootstrapValidator').validate().isValid();

        if (vali) {
            $("#useradd").modal("hide");
            $.ajax({
                url: "../insertYj",
                data: $("#formadd").serialize(),
                success: function (data) {

                    $.niftyNoty({
                        type: 'info',
                        icon: 'pli-exclamation icon-2x',
                        message: '添加信息成功',
                        container: 'floating',
                        timer: 3000
                    });
                    dt.ajax.reload();
                }
            })
        }

    })

    $("#demo-dt-basic").on("click", ".chakan", function () {
        var thisindex = $(this).parent().parent().index();
        var id = dt.row(thisindex).data().id;
        var danhao = dt.row(thisindex).data().danhao;
        var station = dt.row(thisindex).data().station;
        var phone = dt.row(thisindex).data().phone;
        var username = dt.row(thisindex).data().username;
        var msg="您的订单号是:"+danhao+"<br>"
            +"收件人是:"+"<span style='color: red'>"+username+"</span>"+"<br>"
            + "收件人手机号是:" +"<span style='color: red'>"+phone+"</span>"+"<br>"
            + "收件人地址是:" +"<span style='color: red'>"+station+"</span>"+"<br>"
            +"确定无误后点击确定按钮";
        bootbox.confirm({
            size: "large",
            message: msg,
            buttons: {
                confirm: {
                    label: '确定',
                    className: 'btn-danger'
                },
                cancel: {
                    label: '取消',
                }
            },
            callback: function (result) {
                if (result) {
                    $.ajax({
                        url: '../curYj',
                        data: "id=" + id,
                        success: function (data) {
                            if (data) {
                                dt.ajax.reload();
                                $.niftyNoty({
                                    type: 'info',
                                    icon: 'pli-exclamation icon-2x',
                                    message: '发货成功',
                                    container: 'floating',
                                    timer: 3000
                                });
                            }
                        }
                    })
                }
            }
        })
    })


    // 格式化时间
    function getMyDate(time) {
        if (typeof (time) == "undefined") {
            return "";
        }
        var oDate = new Date(time),
            oYear = oDate.getFullYear(),
            oMonth = oDate.getMonth() + 1,
            oDay = oDate.getDate(),
            oHour = oDate.getHours(),
            oMin = oDate.getMinutes(),
            oSen = oDate.getSeconds(),
            oTime = oYear + '-' + getzf(oMonth) + '-' + getzf(oDay) + ' ' + getzf(oHour) + ':' + getzf(oMin) + ':' + getzf(oSen);//最后拼接时间

        return oTime;
    };

    //补0操作,当时间数据小于10的时候，给该数据前面加一个0
    function getzf(num) {
        if (parseInt(num) < 10) {
            num = '0' + num;
        }
        return num;
    }


</script>


<!--处理复选框的全选问题-->
<script>

    var checkvalues = ["ALL"];

    //全选按钮的点击
    $("#CheckedAll").click(function () {
        $("#xiugaiyonghu").prop("disabled", false);
        //所有checkbox跟着全选的checkbox走。
        $('[name=uidcheck]:checkbox').prop("checked", this.checked);
        //判断一下是否是选中状态
        if ($("#CheckedAll").prop("checked")) {

            checkvalues = ["ALL"]


        } else {
            checkvalues = [];

        }
    });

    //单个复选框点击
    $("#roleusermess").on("click", ".dfcheckbox", function () {
        $("#xiugaiyonghu").prop("disabled", false);
        //定义一个临时变量，避免重复使用同一个选择器选择页面中的元素，提升程序效率。
        var $tmp = $('[name=uidcheck]:checkbox');
        //用filter方法筛选出选中的复选框。并直接给CheckedAll赋值。
        $('#CheckedAll').prop('checked', $tmp.length == $tmp.filter(':checked').length);

        if ($(this).prop("checked")) {
            for (var i = 0; i < checkvalues.length; i++) {
                if ($(this).val() == checkvalues[i]) {
                    checkvalues.splice(i, 1);
                    break;
                }
            }

        } else {

            checkvalues.push($(this).val());

        }


    });

    // 批量删除
    /*$("#xiugaiyonghu").click(function () {
        $.ajax({
            url: "../batchdelrkxx/updateroleuser",
            data: "uid=" + checkvalues,
            success: function (data) {
                $("#roleusers").modal("hide");
                $.niftyNoty({
                    type: 'info',
                    icon: 'pli-exclamation icon-2x',
                    message: '修改数据成功',
                    container: 'floating',
                    timer: 3000
                });
            }
        })
    })*/

</script>


</body>
</html>

